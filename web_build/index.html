<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zen Chat Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.2/marked.min.js"></script>
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- PDF.js for rendering PDFs as images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set worker for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-body: #ffffff;
            --bg-sidebar: #f8fafc;
            --bg-header: rgba(255, 255, 255, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent: #4f46e5;
            --accent-gradient: linear-gradient(135deg, #4f46e5, #6366f1);
            --bubble-user: #4f46e5;
            --bubble-user-text: #ffffff;
            --bubble-ai: #f8fafc;
            --bubble-ai-text: #1e293b;
            --border: #e2e8f0;
            --input-bg: #f8fafc;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --success: #10b981;
            --warning: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --bg-sidebar: #1e293b;
            --bg-header: rgba(15, 23, 42, 0.9);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent: #6366f1;
            --bubble-user: #6366f1;
            --bubble-ai: #1e293b;
            --bubble-ai-text: #f8fafc;
            --border: #334155;
            --input-bg: #1e293b;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            /* Fallback */
            height: 100dvh;
            /* Dynamic Viewport Height for Mobile */
            color: var(--text-primary);
            overflow: hidden;
        }

        @media (max-width: 768px) {
            body {
                height: 90vh !important;
                height: 90dvh !important;
                /* Center the app vertically if desired, or just leave empty space at bottom */
                position: relative;
            }
        }

        /* Sidebar (Desktop) */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            transition: transform 0.3s ease;
            z-index: 100;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                height: 100%;
                transform: translateX(-100%);
                box-shadow: var(--shadow-lg);
            }

            .sidebar.open {
                transform: translateX(0);
            }
        }

        .logo {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
            transition: 0.2s;
            margin-bottom: 4px;
        }

        .menu-item:hover {
            background: var(--border);
        }

        .menu-item.active {
            background: var(--accent);
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-body);
        }

        /* Header */
        .header {
            padding: 16px 24px;
            background: var(--bg-header);
            backdrop-filter: blur(12px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }

        .model-selector {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
        }

        .model-selector:hover {
            background: var(--border);
        }

        .token-counter {
            font-size: 12px;
            color: var(--text-secondary);
            background: var(--bg-sidebar);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            background: var(--border);
        }

        /* Chat Area */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 24px;
            scroll-behavior: smooth;
        }

        .chat-content {
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .message {
            display: flex;
            gap: 16px;
            line-height: 1.6;
            font-size: 16px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
            font-size: 14px;
        }

        .avatar.user {
            background: var(--accent);
            color: white;
        }

        .avatar.ai {
            background: #10a37f;
            color: white;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .message-text {
            color: var(--text-primary);
        }

        /* Code Blocks */
        pre {
            background: #1e1e1e;
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 12px 0;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
        }

        /* Input Area */
        .input-area-container {
            padding: 20px;
            background: var(--bg-body);
            border-top: 1px solid var(--border);
        }

        .input-area-wrapper {
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .input-box {
            background: var(--bg-body);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
        }

        .input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            max-height: 200px;
            font-family: inherit;
            padding: 0;
            line-height: 1.5;
            outline: none;
        }

        .input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }

        .action-left {
            display: flex;
            gap: 8px;
        }

        .send-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.2s;
        }

        .send-btn:hover {
            opacity: 0.9;
        }

        .send-btn:disabled {
            background: var(--border);
            cursor: not-allowed;
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-body);
            border-radius: 16px;
            padding: 24px;
            width: 400px;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
        }

        .modal h2 {
            margin-top: 0;
            margin-bottom: 20px;
        }

        .setting-group {
            margin-bottom: 16px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
        }

        .setting-input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        .save-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        /* New Settings Modal Styles */
        .settings-container {
            display: flex;
            height: 500px;
            max-height: 80vh;
        }

        .settings-sidebar {
            width: 200px;
            border-right: 1px solid var(--border);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .settings-tab {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: var(--text-primary);
            font-weight: 500;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-tab:hover {
            background: var(--border);
        }

        .settings-tab.active {
            background: var(--accent);
            color: white;
        }

        .settings-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .settings-section {
            display: none;
        }

        .settings-section.active {
            display: block;
        }

        .settings-section h3 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .toggle-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .toggle-label {
            font-weight: 500;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--accent);
        }

        input:checked+.slider:before {
            transform: translateX(16px);
        }

        .modal {
            width: 700px;
            /* Wider for new layout */
            padding: 0;
            /* Reset padding for internal layout */
            overflow: hidden;
        }

        /* Presentation Styles */
        .slide-view-modal {
            width: 90vw;
            height: 90vh;
            background: black;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .slide-container {
            flex: 1;
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            height: 100%;
        }

        .slide {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            scroll-snap-align: start;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px;
            box-sizing: border-box;
            text-align: center;
            position: relative;
        }

        .slide h2 {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .slide p {
            font-size: 1.5rem;
            max-width: 800px;
            line-height: 1.6;
        }

        .slide ul {
            text-align: left;
            font-size: 1.5rem;
            margin-top: 20px;
        }

        .slide li {
            margin-bottom: 10px;
        }

        /* Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Quicksand:wght@400;600&display=swap');

        /* Templates */
        /* Warm / Pastel Theme (User Request) */
        .theme-warm {
            background: #FFF5E6;
            color: #5D4037;
            font-family: 'Quicksand', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .theme-warm::before {
            content: '';
            position: absolute;
            top: -100px;
            left: -100px;
            width: 400px;
            height: 400px;
            background: rgba(255, 200, 200, 0.3);
            border-radius: 50%;
            filter: blur(50px);
            z-index: 0;
        }

        .theme-warm::after {
            content: '';
            position: absolute;
            bottom: -50px;
            right: -50px;
            width: 300px;
            height: 300px;
            background: rgba(170, 200, 255, 0.3);
            border-radius: 50%;
            filter: blur(40px);
            z-index: 0;
        }

        .theme-warm h2 {
            font-family: 'Playfair Display', serif;
            color: #8E44AD;
            /* Deep Purple */
            font-size: 2.5rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .theme-warm p,
        .theme-warm li {
            font-size: 1.1rem;
            line-height: 1.6;
            position: relative;
            z-index: 1;
        }

        /* Layouts */
        .layout-split {
            display: flex;
            align-items: center;
            gap: 30px;
            height: 100%;
        }

        .layout-split .content-side {
            flex: 1;
        }

        .layout-split .image-side {
            flex: 1;
        }

        .layout-split img {
            width: 100%;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .layout-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .grid-card {
            background: rgba(255, 255, 255, 0.6);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .grid-card h3 {
            color: #D35400;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-family: 'Playfair Display', serif;
        }

        .grid-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }

        .layout-circular {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            position: relative;
        }

        .circle-container {
            position: relative;
            width: 400px;
            height: 400px;
        }

        .circle-item {
            position: absolute;
            width: 140px;
            height: 140px;
            background: #FFCCBC;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .circle-item:nth-child(1) {
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #FFE0B2;
        }

        .circle-item:nth-child(2) {
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: #FFCCBC;
        }

        .circle-item:nth-child(3) {
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background: #F8BBD0;
        }

        .circle-item:nth-child(4) {
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            background: #E1BEE7;
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: white;
            border-radius: 50%;
            z-index: 2;
        }

        .theme-modern {
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: #fff;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        .theme-modern h2 {
            color: #00d2ff;
            text-transform: uppercase;
            letter-spacing: 3px;
            font-weight: 300;
            margin-bottom: 40px;
        }

        .theme-modern p {
            font-weight: 300;
            letter-spacing: 0.5px;
        }

        .theme-modern li::marker {
            color: #00d2ff;
        }

        .theme-pro {
            background: #fdfbf7;
            color: #2c3e50;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            border: none;
        }

        .theme-pro h2 {
            color: #2c3e50;
            font-weight: 700;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 15px;
            display: inline-block;
        }

        .theme-pro .slide {
            border-top: 10px solid #34495e;
            border-bottom: 10px solid #e74c3c;
        }

        .theme-creative {
            background: #8E2DE2;
            background: linear-gradient(to right, #4A00E0, #8E2DE2);
            color: white;
            font-family: 'Poppins', sans-serif;
        }

        .theme-creative h2 {
            color: #fff;
            font-weight: 800;
            font-size: 3.5rem;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .theme-creative div {
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .theme-minimal {
            background: #ffffff;
            color: #000000;
            font-family: 'Inter', sans-serif;
        }

        .theme-minimal h2 {
            font-weight: 900;
            letter-spacing: -1px;
            font-size: 4rem;
            margin-bottom: 10px;
        }

        .theme-minimal p {
            font-weight: 300;
            color: #555;
        }

        .theme-minimal .slide {
            align-items: flex-start;
            text-align: left;
            padding: 60px;
        }

        .theme-cyber {
            background: #000000;
            color: #00ff00;
            font-family: 'JetBrains Mono', monospace;
        }

        .theme-cyber h2 {
            text-shadow: 0 0 10px #00ff00;
            border: 1px solid #00ff00;
            padding: 10px 20px;
            display: inline-block;
        }

        .theme-cyber p,
        .theme-cyber li {
            color: #ccffcc;
        }

        .theme-nature {
            background: #e8f5e9;
            color: #1b5e20;
            font-family: 'Georgia', serif;
        }

        .theme-nature h2 {
            color: #2e7d32;
            font-style: italic;
        }

        .theme-nature .slide {
            background-image: radial-gradient(#c8e6c9 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Template Selection Grid */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }

        .template-card {
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
            position: relative;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .template-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .template-preview {
            height: 80px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .template-name {
            padding: 8px;
            font-size: 12px;
            text-align: center;
            background: var(--input-bg);
            border-top: 1px solid var(--border);
            font-weight: 500;
        }

        .play-icon {
            width: 0;
            height: 0;
            border-top: 6px solid transparent;
            border-bottom: 6px solid transparent;
            border-left: 10px solid white;
            margin-right: 8px;
        }

        /* Slide Animations */
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-animate {
            animation: slideInUp 0.6s ease-out forwards;
            opacity: 0;
            /* Start hidden */
        }

        /* Code Blocks & Copy */
        .code-block-wrapper {
            position: relative;
            margin: 10px 0;
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: #2d2d2d;
            color: #ccc;
            font-size: 12px;
        }

        .copy-btn {
            background: transparent;
            border: none;
            color: #fff;
            cursor: pointer;
            font-size: 11px;
            opacity: 0.7;
        }

        .copy-btn:hover {
            opacity: 1;
        }

        pre {
            margin: 0;
            padding: 15px;
            overflow-x: auto;
            color: #d4d4d4;
        }

        /* TTS Button */
        .tts-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            margin-left: 5px;
            padding: 2px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .tts-btn:hover {
            opacity: 1;
            color: var(--accent);
        }

        /* New Presentation Themes */
        /* Neon */
        .theme-neon {
            background: #000;
            color: #fff;
            font-family: 'Courier New', monospace;
        }

        .theme-neon h2 {
            color: #0ff;
            text-shadow: 0 0 10px #0ff;
        }

        .theme-neon p,
        .theme-neon li {
            color: #e0e0e0;
        }

        .theme-neon .slide-image {
            border: 2px solid #f0f;
            box-shadow: 0 0 15px #f0f;
        }

        /* Corporate */
        .theme-corporate {
            background: #f0f2f5;
            color: #333;
            font-family: 'Arial', sans-serif;
        }

        .theme-corporate h2 {
            color: #1a237e;
            border-bottom: 3px solid #1a237e;
            display: inline-block;
            padding-bottom: 10px;
        }

        .theme-corporate .slide-number {
            color: #1a237e;
            font-weight: bold;
        }

        /* Minimal */
        .theme-minimal {
            background: #fff;
            color: #000;
            font-family: 'Helvetica Neue', sans-serif;
        }

        .theme-minimal h2 {
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Chat History Sidebar */
        .chat-history {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
            padding-top: 5px;
            scrollbar-width: thin;
            min-height: 100px;
        }

        .sidebar-section-label {
            font-size: 11px;
            font-weight: bold;
            color: var(--text-secondary);
            padding: 15px 10px 5px 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .history-item {
            padding: 10px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .history-item:hover {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        .history-item.active {
            background: var(--input-bg);
            color: var(--accent);
            font-weight: 600;
        }

        .delete-chat {
            opacity: 0;
            color: #ff4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 2px 5px;
            font-size: 14px;
        }

        .history-item:hover .delete-chat {
            opacity: 1;
        }

        /* Presentation Layouts & Images */
        .slide-container.vertical {
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            scroll-snap-type: y mandatory;
        }

        .slide-container.vertical .slide {
            min-width: 100%;
            height: auto;
            min-height: 600px;
            margin-bottom: 20px;
            scroll-snap-align: start;
        }

        .slide-image {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .slide-number {
            position: absolute;
            bottom: 20px;
            right: 20px;
            font-size: 14px;
            opacity: 0.7;
            font-weight: bold;
        }

        .view-controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 101;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
        }

        .view-mode-btn {
            background: transparent;
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .view-mode-btn.active {
            background: var(--accent);
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <!-- Robot Chatbot Icon -->
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" style="color: #2563eb;">
                <!-- Head/Chat Bubble -->
                <path d="M4 6a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3h-2l-4 4v-4H7a3 3 0 0 1-3-3V6z"></path>
                <!-- Antenna -->
                <line x1="12" y1="3" x2="12" y2="0.5"></line>
                <circle cx="12" cy="0.5" r="1.5" fill="none"></circle>
                <!-- Ears -->
                <path d="M2 9v6"></path>
                <path d="M22 9v6"></path>
                <!-- Eyes -->
                <path d="M9 11.5c.5 1 1.5 1 2 0" stroke-width="2"></path> <!-- Wink Left -->
                <circle cx="15" cy="11" r="1.5" fill="currentColor"></circle> <!-- Solid Right -->
                <!-- Mouth -->
                <path d="M10 15.5a2.5 2.5 0 0 0 4 0"></path>
            </svg>
            <span
                style="background: linear-gradient(45deg, #2563eb, #1d4ed8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -0.5px; margin-left: 10px; font-size: 20px;">Zenith
                AI</span>
        </div>
        <div class="menu-item active" onclick="newChat()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 5v14M5 12h14" />
            </svg>
            <span id="newChatText">Neuer Chat</span>
        </div>

        <div class="menu-item" onclick="openPresentationModal()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="3" y1="9" x2="21" y2="9"></line>
                <line x1="9" y1="21" x2="9" y2="9"></line>
            </svg>
            <span id="presentationText">Präsentation</span>
        </div>

        <div class="menu-item" onclick="newChat()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span id="newChatText">Neuer Chat</span>
        </div>

        <div class="menu-item" onclick="toggleSearch()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <span>Chats suchen</span>
        </div>
        <div id="searchContainer" style="display:none; padding: 0 10px 10px 10px;">
            <input type="text" id="chatSearchInput" placeholder="Search..."
                style="width:100%; padding:8px; border-radius:6px; border:1px solid var(--border); background:var(--input-bg); color:var(--text-primary); font-size:13px;"
                oninput="filterChats(this.value)">
        </div>

        <div class="menu-item" onclick="openLibrary()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                    d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                </path>
            </svg>
            <span>Bibliothek</span>
        </div>

        <div class="menu-item" onclick="exportChat()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>Export Chat</span>
        </div>

        <div class="sidebar-section-label">Chats</div>
        <div class="chat-history" id="chatHistoryList">
            <!-- Chat Items -->
        </div>

        <div class="sidebar-section-label">Presentations</div>
        <div class="chat-history" id="presentationHistoryList">
            <!-- Presentation Items -->
        </div>

        <div class="menu-item" onclick="toggleTheme()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <span id="darkModeText">Dark Mode</span>
        </div>
        <div class="menu-item" onclick="toggleSettings()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                </path>
            </svg>
            <span id="settingsText">Einstellungen</span>
        </div>
    </div>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="12" x2="21" y2="12"></line>
                        <line x1="3" y1="6" x2="21" y2="6"></line>
                        <line x1="3" y1="18" x2="21" y2="18"></line>
                    </svg>
                </button>
                <div class="model-selector">
                    Zen AI <span style="font-size: 12px; color: var(--text-secondary);">▼</span>
                </div>
            </div>
            <div class="token-counter" id="tokenCount">0 Tokens</div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container" id="chatArea">
            <div class="chat-content" id="chatContent">
                <!-- Messages will be added here dynamically -->
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area-container">
            <div class="input-area-wrapper">
                <div class="input-box">
                    <div id="imagePreviewContainer"
                        style="display: none; padding: 10px; border-bottom: 1px solid var(--border);">
                        <div style="position: relative; display: inline-block;">
                            <img id="imagePreview" src="" style="max-height: 100px; border-radius: 8px;">
                            <button onclick="clearImage()"
                                style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;">&times;</button>
                        </div>
                    </div>
                    <textarea id="input" rows="1" placeholder="Schreibe eine Nachricht..."></textarea>
                    <div class="input-actions">
                        <div class="action-left">
                            <input type="file" id="imageInput" accept="image/*" style="display: none;"
                                onchange="handleImageSelect(this)">
                            <button class="icon-btn" onclick="document.getElementById('imageInput').click()"
                                id="attachBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path
                                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
                                    </path>
                                </svg>
                            </button>
                            <button class="icon-btn" onclick="toggleVoice()" id="micBtn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                    <line x1="12" y1="19" x2="12" y2="23"></line>
                                    <line x1="8" y1="23" x2="16" y2="23"></line>
                                </svg>
                            </button>
                        </div>
                        <button class="send-btn" onclick="sendMessage()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="disclaimer"
                    style="text-align: center; font-size: 12px; color: var(--text-secondary); margin-top: 10px;">
                    Zen Chat kann Fehler machen. Überprüfe wichtige Informationen.
                </div>
            </div>
        </div>
    </div>

    <!-- New Comprehensive Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="settings-container">
                <!-- Sidebar -->
                <div class="settings-sidebar">
                    <div class="settings-tab active" onclick="switchTab('general')" id="tabGeneral">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                            </path>
                        </svg>
                        Allgemein
                    </div>
                    <div class="settings-tab" onclick="switchTab('account')" id="tabAccount">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                            <circle cx="12" cy="7" r="4"></circle>
                        </svg>
                        Konto
                    </div>
                    <div class="settings-tab" onclick="switchTab('data')" id="tabData">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Datenschutz
                    </div>
                </div>

                <!-- Content -->
                <div class="settings-content">
                    <!-- General Section -->
                    <div class="settings-section active" id="section-general">
                        <h3 id="generalTitle">Allgemeine Einstellungen</h3>

                        <div class="setting-group">
                            <label class="setting-label" id="langLabel">Sprache / Language / اللغة</label>
                            <select class="setting-input" id="languageSelect">
                                <option value="de">Deutsch</option>
                                <option value="en">English</option>
                                <option value="ar">العربية</option>
                                <option value="uk">Українська</option>
                            </select>
                        </div>

                        <div class="setting-group">
                            <label class="setting-label" id="apiKeyLabel">API Key</label>
                            <input type="password" class="setting-input" id="apiKeyInput" placeholder="sk-...">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label" id="sysPromptLabel">System Prompt</label>
                            <textarea class="setting-input" id="systemPrompt" rows="3"
                                placeholder="Du bist ein hilfreicher Assistent..."></textarea>
                        </div>

                        <div class="toggle-row">
                            <span class="toggle-label" id="audioModeLabel">Audio-Modus</span>
                            <label class="switch">
                                <input type="checkbox" id="audioModeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="toggle-row">
                            <span class="toggle-label" id="autocompleteLabel">Automatisch vervollständigen</span>
                            <label class="switch">
                                <input type="checkbox" id="autocompleteToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <!-- Account Section -->
                    <div class="settings-section" id="section-account">
                        <h3 id="accountTitle">Benutzerkonto</h3>

                        <div class="setting-group">
                            <label class="setting-label" id="emailLabel">E-Mail</label>
                            <input type="email" class="setting-input" id="emailInput" placeholder="name@example.com">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label" id="phoneLabel">Telefonnummer</label>
                            <input type="tel" class="setting-input" id="phoneInput" placeholder="+49 123 456789">
                        </div>

                        <div class="setting-group">
                            <label class="setting-label" id="subLabel">Abonnement</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                <!-- Plan 1 -->
                                <div
                                    style="padding: 15px 10px; border: 1px solid var(--border); border-radius: 8px; text-align: center; background: var(--input-bg);">
                                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;"
                                        id="plan1Title">Basic</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                        Free</div>
                                    <button id="plan1Btn"
                                        style="background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Abonnieren</button>
                                </div>
                                <!-- Plan 2 -->
                                <div
                                    style="padding: 15px 10px; border: 1px solid var(--accent); border-radius: 8px; text-align: center; background: var(--input-bg); position: relative;">
                                    <div
                                        style="position: absolute; top: -8px; left: 50%; transform: translateX(-50%); background: var(--accent); color: white; font-size: 10px; padding: 2px 8px; border-radius: 10px;">
                                        Popular</div>
                                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;"
                                        id="plan2Title">Pro</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                        $9.99/mo</div>
                                    <button id="plan2Btn"
                                        style="background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Abonnieren</button>
                                </div>
                                <!-- Plan 3 -->
                                <div
                                    style="padding: 15px 10px; border: 1px solid var(--border); border-radius: 8px; text-align: center; background: var(--input-bg);">
                                    <div style="font-weight: 600; margin-bottom: 10px; font-size: 14px;"
                                        id="plan3Title">Ultra</div>
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">
                                        $19.99/mo</div>
                                    <button id="plan3Btn"
                                        style="background: var(--accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;">Abonnieren</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Section -->
                    <div class="settings-section" id="section-data">
                        <h3 id="dataTitle">Sicherheit & Daten</h3>

                        <div class="toggle-row">
                            <span class="toggle-label" id="historyLabel">Chat-Verlauf speichern</span>
                            <label class="switch">
                                <input type="checkbox" id="historyToggle" checked>
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div style="margin-top: 20px;">
                            <button class="setting-input"
                                style="text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                                <span id="archivedChatsLabel">Archivierte Chats</span>
                                <span>&rsaquo;</span>
                            </button>
                        </div>

                        <div style="margin-top: 10px;">
                            <button class="setting-input"
                                style="text-align: left; cursor: pointer; display: flex; justify-content: space-between; align-items: center; color: red; border-color: red;">
                                <span id="clearDataLabel">Alle Daten löschen</span>
                            </button>
                        </div>

                        <div style="margin-top: 20px; font-size: 12px; color: var(--text-secondary);">
                            <a href="#" style="color: var(--accent); text-decoration: none;">Privacy Policy</a> &bull;
                            <a href="#" style="color: var(--accent); text-decoration: none;">Terms of Service</a>
                        </div>
                    </div>
                </div>
            </div>
            <div style="padding: 20px; border-top: 1px solid var(--border); text-align: right;">
                <button class="save-btn" style="width: auto; margin: 0;" id="saveBtn"
                    onclick="toggleSettings()">Speichern & Schließen</button>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div class="modal-overlay" id="pinModal" style="z-index: 3000;">
        <div class="modal">
            <h2 id="pinTitle">Sicherheitscode</h2>
            <p id="pinDesc" style="margin-bottom: 15px; color: var(--text-secondary);">Bitte geben Sie den PIN ein, um
                den Chat
                fortzusetzen.</p>
            <div class="setting-group">
                <input type="password" class="setting-input" id="pinInput" placeholder="PIN eingeben">
            </div>
            <button class="save-btn" id="pinBtn" onclick="verifyPin()">Bestätigen</button>
            <p id="pinError" style="color: red; font-size: 12px; margin-top: 10px; display: none;">Falscher PIN</p>
        </div>
    </div>

    <!-- Presentation Setup Modal -->
    <div class="modal-overlay" id="pptSetupModal">
        <div class="modal" style="width: 600px; padding: 30px;">
            <h2 id="pptTitle" style="margin-bottom: 20px;">Präsentation erstellen</h2>

            <div class="setting-group">
                <label class="setting-label" id="pptTopicLabel">Thema / Inhalt</label>
                <textarea class="setting-input" id="pptTopic" rows="6"
                    placeholder="Thema eingeben oder Text hier einfügen..."></textarea>
            </div>

            <div class="setting-group">
                <label class="setting-label" id="pptStyleLabel">Design wählen</label>
                <div class="template-grid">
                    <!-- Modern -->
                    <div class="template-card selected" onclick="selectTemplate(this, 'modern')">
                        <div class="template-preview"
                            style="background: linear-gradient(135deg, #0f2027, #2c5364); color: #00d2ff;">Abc</div>
                        <div class="template-name">Modern</div>
                    </div>
                    <!-- Pro -->
                    <div class="template-card" onclick="selectTemplate(this, 'pro')">
                        <div class="template-preview"
                            style="background: #fdfbf7; color: #2c3e50; border-bottom: 3px solid #e74c3c;">Abc</div>
                        <div class="template-name">Professional</div>
                    </div>
                    <!-- Creative -->
                    <div class="template-card" onclick="selectTemplate(this, 'creative')">
                        <div class="template-preview"
                            style="background: linear-gradient(to right, #4A00E0, #8E2DE2); color: white;">Abc</div>
                        <div class="template-name">Creative</div>
                    </div>
                    <!-- Minimal -->
                    <div class="template-card" onclick="selectTemplate(this, 'minimal')">
                        <div class="template-preview"
                            style="background: #fff; color: #000; font-family: sans-serif; font-weight: 900;">Abc</div>
                        <div class="template-name">Minimal</div>
                    </div>
                    <!-- Cyber -->
                    <div class="template-card" onclick="selectTemplate(this, 'cyber')">
                        <div class="template-preview"
                            style="background: #000; color: #00ff00; border: 1px solid #00ff00;">Abc</div>
                        <div class="template-name">Cyber</div>
                    </div>
                    <!-- Nature -->
                    <div class="template-card" onclick="selectTemplate(this, 'nature')">
                        <div class="template-preview" style="background: #e8f5e9; color: #1b5e20;">Abc</div>
                        <div class="template-name">Nature</div>
                    </div>
                    <!-- Warm (New) -->
                    <div class="template-card" onclick="selectTemplate(this, 'warm')">
                        <div class="template-preview" style="background: #FFF5E6; color: #8E44AD; font-family: serif;">
                            Abc</div>
                        <div class="template-name">Warm</div>
                    </div>
                    <div class="template-card" onclick="selectTemplate(this, 'neon')">
                        <div class="template-preview" style="background: #000; border: 1px solid #0ff; color: #0ff;">Abc
                        </div>
                        <div class="template-name">Neon</div>
                    </div>
                    <div class="template-card" onclick="selectTemplate(this, 'corporate')">
                        <div class="template-preview"
                            style="background: #f0f2f5; color: #333; font-family: 'Segoe UI', sans-serif;">Abc</div>
                        <div class="template-name">Corp</div>
                    </div>
                    <div class="template-card" onclick="selectTemplate(this, 'minimal')">
                        <div class="template-preview"
                            style="background: #fff; border: 1px solid #ccc; color: #333; font-family: sans-serif; font-weight: 900;">
                            Abc</div>
                        <div class="template-name">Minimal</div>
                    </div>
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="save-btn"
                    style="background: transparent; border: 1px solid var(--border); color: var(--text-primary); width: auto;"
                    onclick="document.getElementById('pptSetupModal').style.display='none'">Abbrechen</button>
                <button class="save-btn" id="pptGenBtn" onclick="generatePresentation()"
                    style="width: auto; display: flex; align-items: center; padding-left: 20px; padding-right: 20px;">
                    <div class="play-icon"></div>
                    <span id="pptGenText">Erstellen</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Presentation View Modal -->
    <div class="modal-overlay" id="pptViewModal" style="z-index: 2000;">
        <div class="modal slide-view-modal">
            <button onclick="document.getElementById('pptViewModal').style.display='none'"
                style="position: absolute; top: 20px; right: 20px; z-index: 101; background: rgba(0,0,0,0.5); color: white; border: none; font-size: 24px; cursor: pointer; width: 40px; height: 40px; border-radius: 50%;">&times;</button>

            <div class="view-controls">
                <button class="view-mode-btn active" onclick="toggleLayout('horizontal')"
                    id="btnHorizontal">Horizontal</button>
                <button class="view-mode-btn" onclick="toggleLayout('vertical')" id="btnVertical">Vertical</button>
            </div>

            <div class="slide-container" id="slideContainer">
                <!-- Slides go here -->
            </div>
            <div class="slide-controls">
                <button class="slide-btn"
                    onclick="document.getElementById('slideContainer').scrollBy({left: -window.innerWidth, behavior: 'smooth'})">←</button>
                <button class="slide-btn export-btn" onclick="exportToPDF()" id="exportPdfBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    PDF Export
                </button>
                <button class="slide-btn"
                    onclick="document.getElementById('slideContainer').scrollBy({left: window.innerWidth, behavior: 'smooth'})">→</button>
            </div>
        </div>
    </div>
    <style>
        /* Code Block Styling */
        .code-block-wrapper {
            position: relative;
            background: var(--code-bg);
            border-radius: 8px;
            margin-top: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid var(--code-border);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--code-header-bg);
            color: var(--code-header-text);
            font-size: 0.8em;
            border-bottom: 1px solid var(--code-border);
        }

        .code-header span {
            font-family: monospace;
            text-transform: uppercase;
        }

        .copy-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.75em;
            transition: background 0.2s ease;
        }

        .copy-btn:hover {
            background: var(--accent-hover);
        }

        .code-block-wrapper pre {
            margin: 0;
            padding: 15px;
            overflow-x: auto;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .code-block-wrapper code {
            display: block;
            color: var(--code-text);
            font-family: 'Fira Code', 'Cascadia Code', monospace;
        }

        /* TTS Button */
        .tts-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 10px;
            transition: color 0.2s ease;
        }

        .tts-btn:hover {
            color: var(--accent);
        }

        /* Presentation Themes */
        .slide-container.theme-warm .slide {
            background: #FFF5E6;
            color: #8E44AD;
            font-family: 'Georgia', serif;
        }

        .slide-container.theme-warm h2 {
            color: #C70039;
        }

        .slide-container.theme-warm .grid-card,
        .slide-container.theme-warm .circle-item {
            background: #FFC300;
            color: #333;
            border: 1px solid #FF5733;
        }

        .slide-container.theme-neon .slide {
            background: #000;
            color: #0ff;
            font-family: 'Press Start 2P', cursive;
            text-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 15px #0ff;
        }

        .slide-container.theme-neon h2 {
            color: #f0f;
            text-shadow: 0 0 5px #f0f, 0 0 10px #f0f;
        }

        .slide-container.theme-neon .grid-card,
        .slide-container.theme-neon .circle-item {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid #0ff;
            box-shadow: 0 0 5px #0ff;
        }

        .slide-container.theme-corporate .slide {
            background: #f0f2f5;
            color: #333;
            font-family: 'Segoe UI', sans-serif;
        }

        .slide-container.theme-corporate h2 {
            color: #0056b3;
        }

        .slide-container.theme-corporate .grid-card,
        .slide-container.theme-corporate .circle-item {
            background: #fff;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .slide-container.theme-minimal .slide {
            background: #fff;
            color: #333;
            font-family: 'Helvetica Neue', sans-serif;
            border: 1px solid #eee;
        }

        .slide-container.theme-minimal h2 {
            color: #000;
        }

        .slide-container.theme-minimal .grid-card,
        .slide-container.theme-minimal .circle-item {
            background: #f9f9f9;
            border: 1px solid #eee;
        }

        /* Library Modal Specific Styles */
        #libraryModal.modal-overlay {
            z-index: 2000;
            /* Ensure it's on top */
        }

        #libraryModal .modal-content {
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        #libraryList {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        #libraryList .history-item {
            flex-direction: column;
            align-items: flex-start;
            height: auto;
            cursor: default;
            background: var(--input-bg);
            border: 1px solid var(--border);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease;
        }

        #libraryList .history-item:hover {
            transform: translateY(-2px);
        }

        #libraryList .history-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        #libraryList .history-item div:first-of-type {
            /* Text content */
            font-size: 12px;
            margin-bottom: 10px;
            max-height: 100px;
            overflow-y: auto;
            color: var(--text-primary);
        }

        #libraryList .history-item div:last-of-type {
            /* Date and delete button */
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: auto;
            align-items: center;
        }

        #libraryList .history-item span {
            /* Date */
            font-size: 10px;
            color: var(--text-secondary);
        }

        #libraryList .history-item button {
            /* Delete button */
            color: var(--text-secondary);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
        }

        #libraryList .history-item button:hover {
            background: rgba(255, 0, 0, 0.1);
            color: red;
        }

        /* New Library Styles */
        .lib-filter-btn {
            text-align: left;
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .lib-filter-btn:hover {
            background: var(--input-bg);
        }

        .lib-filter-btn.active {
            background: var(--accent);
            color: white;
        }

        .lib-card-actions {
            display: flex;
            gap: 10px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .lib-btn {
            flex: 1;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 12px;
            text-align: center;
        }

        .lib-btn:hover {
            background: var(--input-bg);
        }

        .lib-btn.primary {
            background: var(--accent);
            color: white;
            border: none;
        }
    </style>
    <!-- Library Modal -->
    <div id="libraryModal" class="modal-overlay">
        <div class="modal-content"
            style="max-width: 800px; height: 80vh; display:flex; flex-direction:column; padding: 0; overflow: hidden; background: var(--bg-color);">

            <!-- Header -->
            <div class="modal-header"
                style="padding: 15px 20px; border-bottom: 1px solid var(--border); background: var(--bg-color); display:flex; justify-content:space-between; align-items:center;">
                <h2 style="margin:0; display:flex; align-items:center; gap:10px; font-size: 18px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                    </svg>
                    Bibliothek
                </h2>
                <button class="close-btn" onclick="document.getElementById('libraryModal').style.display='none'"
                    style="font-size:24px;">&times;</button>
            </div>

            <!-- Controls (Search & Filters) -->
            <div
                style="padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; background: var(--input-bg);">
                <div style="position: relative; flex: 1;">
                    <input type="text" id="libSearch" placeholder="Suchen..." oninput="renderLibrary()"
                        style="width: 100%; padding: 8px 10px 8px 30px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-color); color: var(--text-primary); font-size: 13px;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); opacity: 0.5;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                    </svg>
                </div>

                <div style="display:flex; gap:5px;">
                    <button class="lib-filter-btn active" onclick="setLibFilter('all', this)"
                        style="padding: 6px 12px; font-size: 13px; border-radius: 6px;">Alle</button>
                    <button class="lib-filter-btn" onclick="setLibFilter('image', this)"
                        style="padding: 6px 12px; font-size: 13px; border-radius: 6px;">Bilder</button>
                    <button class="lib-filter-btn" onclick="setLibFilter('text', this)"
                        style="padding: 6px 12px; font-size: 13px; border-radius: 6px;">Texte</button>
                </div>
            </div>

            <!-- Grid Content -->
            <div id="libraryList"
                style="flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; align-content: start; background: var(--bg-color);">
                <!-- Items -->
            </div>
        </div>
    </div>

    <script>
        console.log("Zen Chat v3.0 - Loaded at " + new Date().toISOString());

        // Custom Marked Renderer for Copy Button
        const renderer = new marked.Renderer();
        renderer.code = function (code, language) {
            const validLang = !!(language && hljs.getLanguage(language)) ? language : 'plaintext';
            const highlighted = hljs.highlight(validLang, code).value;
            return `
                <div class="code-block-wrapper">
                    <div class="code-header">
                        <span>${validLang}</span>
                        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
                    </div>
                    <pre><code class="hljs ${validLang}">${highlighted}</code></pre>
                    <div style="display:none" class="raw-code">${encodeURIComponent(code)}</div>
                </div>
            `;
        };
        marked.setOptions({ renderer: renderer });

        function copyToClipboard(btn) {
            const wrapper = btn.closest('.code-block-wrapper');
            const rawCode = decodeURIComponent(wrapper.querySelector('.raw-code').innerText);
            navigator.clipboard.writeText(rawCode).then(() => {
                const original = btn.innerText;
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = original, 2000);
            });
        }

        const chatContent = document.getElementById('chatContent');
        const chatArea = document.getElementById('chatArea');
        const input = document.getElementById('input');
        const micBtn = document.getElementById('micBtn');
        const settingsModal = document.getElementById('settingsModal');
        const pinModal = document.getElementById('pinModal');
        const pinInput = document.getElementById('pinInput');
        const pinError = document.getElementById('pinError');
        const tokenCount = document.getElementById('tokenCount');
        const languageSelect = document.getElementById('languageSelect');
        const imageInput = document.getElementById('imageInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreview = document.getElementById('imagePreview');
        let currentImageBase64 = null;

        // Hardcoded API Key (Hidden from UI)
        const defaultKey = '';
        let apiKey = localStorage.getItem('apiKey') || defaultKey;

        // Chat History State - Moved to top to avoid initialization errors
        let allChats;
        try {
            allChats = JSON.parse(localStorage.getItem('allChats'));
        } catch (e) {
            allChats = [];
        }
        if (!Array.isArray(allChats)) allChats = [];

        // Presentation History State
        let allPresentations;
        try {
            allPresentations = JSON.parse(localStorage.getItem('allPresentations'));
        } catch (e) {
            allPresentations = [];
        }
        if (!Array.isArray(allPresentations)) allPresentations = [];

        // Library State
        let allLibrary;
        try {
            allLibrary = JSON.parse(localStorage.getItem('allLibrary'));
        } catch (e) { allLibrary = []; }
        if (!Array.isArray(allLibrary)) allLibrary = [];

        let currentChatId = Date.now();

        // Ensure we always use the valid key
        if (!apiKey || apiKey.length < 10) {
            apiKey = defaultKey;
            localStorage.setItem('apiKey', apiKey);
        }

        let systemPrompt = localStorage.getItem('systemPrompt') || '';
        let currentLanguage = localStorage.getItem('language') || 'de';
        let recognition;
        let isListening = false;

        // PIN Logic
        let messageCount = 0;
        let isPinVerified = false;
        const CORRECT_PIN = "1532@";
        let conversationHistory = []; // Store conversation context

        // Translations
        const translations = {
            de: {
                newChat: "Neuer Chat",
                darkMode: "Dark Mode",
                settings: "Einstellungen",
                disclaimer: "Zen Chat kann Fehler machen. Überprüfe wichtige Informationen.",
                settingsTitle: "Einstellungen",
                langLabel: "Sprache",
                sysPromptLabel: "System Prompt",
                sysPromptPlaceholder: "Du bist ein hilfreicher Assistent...",
                saveBtn: "Speichern",
                pinTitle: "Sicherheitscode",
                pinDesc: "Bitte geben Sie den PIN ein, um den Chat fortzusetzen.",
                pinPlaceholder: "PIN eingeben",
                pinBtn: "Bestätigen",
                pinError: "Falscher PIN",
                inputPlaceholder: "Schreibe eine Nachricht...",
                greeting: "Hallo! Wie kann ich dir heute helfen?",
                pinAccepted: "PIN akzeptiert. Sie können jetzt fortfahren.",
                modelSelector: "Zen AI",
                tokenCounter: "Tokens",
                // New Translations
                tabGeneral: "Allgemein",
                tabAccount: "Konto",
                tabData: "Datenschutz",
                generalTitle: "Allgemeine Einstellungen",
                accountTitle: "Benutzerkonto",
                dataTitle: "Sicherheit & Daten",
                audioMode: "Audio-Modus",
                autocomplete: "Automatisch vervollständigen",
                email: "E-Mail",
                phone: "Telefonnummer",
                sub: "Abonnement",
                history: "Chat-Verlauf speichern",
                archived: "Archivierte Chats",
                clearData: "Alle Daten löschen",
                subscribe: "Abonnieren",
                plan1: "Basic",
                plan2: "Pro",
                plan3: "Ultra",
                presentation: "Präsentation",
                pptTitle: "Präsentation erstellen",
                pptTopic: "Thema",
                pptStyle: "Stil",
                pptGen: "Erstellen",
                exportPdf: "PDF Exportieren",
                apiKeyLabel: "OpenAI API Schlüssel"
            },
            en: {
                newChat: "New Chat",
                darkMode: "Dark Mode",
                settings: "Settings",
                disclaimer: "Zen Chat can make mistakes. Check important info.",
                settingsTitle: "Settings",
                langLabel: "Language",
                sysPromptLabel: "System Prompt",
                sysPromptPlaceholder: "You are a helpful assistant...",
                saveBtn: "Save & Close",
                pinTitle: "Security Code",
                pinDesc: "Please enter the PIN to continue chatting.",
                pinPlaceholder: "Enter PIN",
                pinBtn: "Confirm",
                pinError: "Incorrect PIN",
                inputPlaceholder: "Type a message...",
                greeting: "Hello! How can I help you today?",
                pinAccepted: "PIN accepted. You can proceed now.",
                modelSelector: "Zen AI",
                tokenCounter: "Tokens",
                // New Translations
                tabGeneral: "General",
                tabAccount: "Account",
                tabData: "Privacy",
                generalTitle: "General Settings",
                accountTitle: "User Account",
                dataTitle: "Security & Data",
                audioMode: "Audio Mode",
                autocomplete: "Autocomplete",
                email: "Email",
                phone: "Phone Number",
                sub: "Subscription",
                history: "Save Chat History",
                archived: "Archived Chats",
                clearData: "Clear All Data",
                subscribe: "Subscribe",
                plan1: "Basic",
                plan2: "Pro",
                plan3: "Ultra",
                presentation: "Presentation",
                pptTitle: "Create Presentation",
                pptTopic: "Topic",
                pptStyle: "Style",
                pptGen: "Generate",
                exportPdf: "Export PDF",
                apiKeyLabel: "OpenAI API Key"
            },
            ar: {
                newChat: "محادثة جديدة",
                darkMode: "الوضع الداكن",
                settings: "الإعدادات",
                disclaimer: "قد يخطئ Zen Chat. تحقق من المعلومات المهمة.",
                settingsTitle: "الإعدادات",
                langLabel: "اللغة",
                sysPromptLabel: "توجيه النظام",
                sysPromptPlaceholder: "أنت مساعد مفيد...",
                saveBtn: "حفظ وإغلاق",
                pinTitle: "رمز الأمان",
                pinDesc: "الرجاء إدخال الرمز السري للمتابعة.",
                pinPlaceholder: "أدخل الرمز",
                pinBtn: "تأكيد",
                pinError: "الرمز غير صحيح",
                inputPlaceholder: "اكتب رسالة...",
                greeting: "مرحباً! كيف يمكنني مساعدتك اليوم؟",
                pinAccepted: "تم قبول الرمز. يمكنك المتابعة الآن.",
                modelSelector: "Zen AI",
                tokenCounter: "الرموز",
                // New Translations
                tabGeneral: "عام",
                tabAccount: "الحساب",
                tabData: "الخصوصية",
                generalTitle: "إعدادات عامة",
                accountTitle: "حساب المستخدم",
                dataTitle: "الأمان والبيانات",
                audioMode: "وضع الصوت",
                autocomplete: "الإكمال التلقائي",
                email: "البريد الإلكتروني",
                phone: "رقم الهاتف",
                sub: "الاشتراك",
                history: "حفظ سجل الدردشة",
                archived: "الدردشات المؤرشفة",
                clearData: "مسح جميع البيانات",
                subscribe: "اشترك",
                plan1: "أساسي",
                plan2: "برو",
                plan3: "ألترا",
                presentation: "عرض تقديمي",
                pptTitle: "إنشاء عرض تقديمي",
                pptTopic: "الموضوع",
                pptStyle: "النمط",
                pptGen: "إنشاء",
                exportPdf: "تصدير PDF",
                apiKeyLabel: "مفتاح OpenAI API"
            },
            uk: {
                newChat: "Новий чат",
                darkMode: "Темний режим",
                settings: "Налаштування",
                disclaimer: "Zen Chat може робити помилки. Перевіряйте важливу інформацію.",
                settingsTitle: "Налаштування",
                langLabel: "Мова",
                sysPromptLabel: "Системна підказка",
                sysPromptPlaceholder: "Ти корисний помічник...",
                saveBtn: "Зберегти та закрити",
                pinTitle: "Код безпеки",
                pinDesc: "Будь ласка, введіть PIN-код, щоб продовжити спілкування.",
                pinPlaceholder: "Введіть PIN",
                pinBtn: "Підтвердити",
                pinError: "Невірний PIN",
                inputPlaceholder: "Введіть повідомлення...",
                greeting: "Привіт! Чим я можу допомогти вам сьогодні?",
                pinAccepted: "PIN прийнято. Ви можете продовжити.",
                modelSelector: "Zen AI",
                tokenCounter: "Токени",
                tabGeneral: "Загальні",
                tabAccount: "Обліковий запис",
                tabData: "Конфіденційність",
                generalTitle: "Загальні налаштування",
                accountTitle: "Обліковий запис",
                dataTitle: "Безпека та дані",
                audioMode: "Аудіо режим",
                autocomplete: "Автозаповнення",
                email: "Електронна пошта",
                phone: "Номер телефону",
                sub: "Підписка",
                history: "Зберігати історію чату",
                archived: "Архівовані чати",
                clearData: "Очистити всі дані",
                subscribe: "Підписатися",
                plan1: "Базовий",
                plan2: "Про",
                plan3: "Ультра",
                presentation: "Презентація",
                pptTitle: "Створити презентацію",
                pptTopic: "Тема",
                pptStyle: "Стиль",
                pptGen: "Створити",
                exportPdf: "Експорт PDF",
                apiKeyLabel: "Ключ OpenAI API"
            }
        };

        function switchTab(tabName) {
            // Hide all sections
            document.querySelectorAll('.settings-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.settings-tab').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(`section-${tabName}`).classList.add('active');

            // Highlight tab
            const tabId = 'tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1);
            document.getElementById(tabId).classList.add('active');
        }

        function updateUILanguage(lang) {
            const t = translations[lang];

            // Sidebar
            document.getElementById('newChatText').innerText = t.newChat;
            document.getElementById('darkModeText').innerText = t.darkMode;
            document.getElementById('settingsText').innerText = t.settings;
            document.getElementById('presentationText').innerText = t.presentation;

            // PPT Modal
            document.getElementById('pptTitle').innerText = t.pptTitle;
            document.getElementById('pptTopicLabel').innerText = t.pptTopic;
            document.getElementById('pptStyleLabel').innerText = t.pptStyle;
            document.getElementById('pptGenText').innerText = t.pptGen;
            document.getElementById('exportPdfBtn').innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:5px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> ${t.exportPdf}`;

            // Main UI
            document.querySelector('.model-selector').firstChild.nodeValue = t.modelSelector + ' '; // Update GPT-4 text
            document.getElementById('tokenCount').innerText = `0 ${t.tokenCounter}`; // Update "Tokens" text
            document.getElementById('disclaimer').innerText = t.disclaimer;
            document.getElementById('input').placeholder = t.inputPlaceholder;

            // Settings Modal (New)
            document.getElementById('tabGeneral').childNodes[2].nodeValue = " " + t.tabGeneral;
            document.getElementById('tabAccount').childNodes[2].nodeValue = " " + t.tabAccount;
            document.getElementById('tabData').childNodes[2].nodeValue = " " + t.tabData;

            document.getElementById('generalTitle').innerText = t.generalTitle;
            document.getElementById('accountTitle').innerText = t.accountTitle;
            document.getElementById('dataTitle').innerText = t.dataTitle;

            document.getElementById('langLabel').innerText = t.langLabel;
            document.getElementById('sysPromptLabel').innerText = t.sysPromptLabel;
            document.getElementById('systemPrompt').placeholder = t.sysPromptPlaceholder;
            document.getElementById('apiKeyLabel').innerText = t.apiKeyLabel;
            document.getElementById('audioModeLabel').innerText = t.audioMode;
            document.getElementById('autocompleteLabel').innerText = t.autocomplete;

            document.getElementById('emailLabel').innerText = t.email;
            document.getElementById('phoneLabel').innerText = t.phone;
            document.getElementById('subLabel').innerText = t.sub;

            document.getElementById('plan1Title').innerText = t.plan1;
            document.getElementById('plan2Title').innerText = t.plan2;
            document.getElementById('plan3Title').innerText = t.plan3;
            document.getElementById('plan1Btn').innerText = t.subscribe;
            document.getElementById('plan2Btn').innerText = t.subscribe;
            document.getElementById('plan3Btn').innerText = t.subscribe;

            document.getElementById('historyLabel').innerText = t.history;
            document.getElementById('archivedChatsLabel').innerText = t.archived;
            document.getElementById('clearDataLabel').innerText = t.clearData;

            document.getElementById('saveBtn').innerText = t.saveBtn;

            // PIN Modal
            document.getElementById('pinTitle').innerText = t.pinTitle;
            document.getElementById('pinDesc').innerText = t.pinDesc;
            document.getElementById('pinInput').placeholder = t.pinPlaceholder;
            document.getElementById('pinBtn').innerText = t.pinBtn;
            document.getElementById('pinError').innerText = t.pinError;

            // Update Greeting if present
            const greetingEl = document.querySelector('[data-translate="greeting"]');
            if (greetingEl) {
                greetingEl.innerHTML = marked.parse(t.greeting);
            }

            // RTL Handling
            const sidebar = document.querySelector('.sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            const inputActions = document.querySelector('.input-actions');
            const settingsSidebar = document.querySelector('.settings-sidebar');

            if (lang === 'ar') {
                document.body.style.direction = 'rtl';
                sidebar.style.borderRight = 'none';
                sidebar.style.borderLeft = '1px solid var(--border)';
                settingsSidebar.style.borderRight = 'none';
                settingsSidebar.style.borderLeft = '1px solid var(--border)';

                menuItems.forEach(item => item.style.flexDirection = 'row');
                inputActions.style.flexDirection = 'row';

            } else {
                document.body.style.direction = 'ltr';
                sidebar.style.borderRight = '1px solid var(--border)';
                sidebar.style.borderLeft = 'none';
                settingsSidebar.style.borderRight = '1px solid var(--border)';
                settingsSidebar.style.borderLeft = 'none';

                menuItems.forEach(item => item.style.flexDirection = 'row');

                inputActions.style.flexDirection = 'row';
            }
        }

        // Initialize Settings UI
        document.getElementById('systemPrompt').value = systemPrompt;
        languageSelect.value = currentLanguage;

        updateUILanguage(currentLanguage);
        newChat(); // Initialize chat with correct greeting

        // Auto-resize textarea
        input.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
            updateTokenCount(this.value);
        });

        // Enter key to send
        input.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function updateTokenCount(text) {
            const count = Math.ceil(text.length / 4);
            tokenCount.innerText = `${count} Tokens`;
        }

        // Voice Recognition
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            // Set language based on selection
            recognition.lang = currentLanguage === 'ar' ? 'ar-SA' : (currentLanguage === 'uk' ? 'uk-UA' : (currentLanguage === 'en' ? 'en-US' : 'de-DE'));

            recognition.onresult = function (event) {
                const text = event.results[0][0].transcript;
                input.value += (input.value ? ' ' : '') + text;
                input.dispatchEvent(new Event('input'));
            };

            recognition.onend = function () {
                isListening = false;
                micBtn.style.color = 'var(--text-primary)';
            };
        } else {
            micBtn.style.display = 'none';
        }

        function toggleVoice() {
            if (!recognition) return;
            // Update lang before starting
            recognition.lang = currentLanguage === 'ar' ? 'ar-SA' : (currentLanguage === 'uk' ? 'uk-UA' : (currentLanguage === 'en' ? 'en-US' : 'de-DE'));

            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
                isListening = true;
                micBtn.style.color = 'red';
            }
        }

        function toggleSettings() {
            if (settingsModal.style.display === 'flex') {
                // Save Settings
                systemPrompt = document.getElementById('systemPrompt').value;
                currentLanguage = languageSelect.value;

                // Save new fields
                localStorage.setItem('userEmail', document.getElementById('emailInput').value);
                localStorage.setItem('userPhone', document.getElementById('phoneInput').value);
                localStorage.setItem('audioMode', document.getElementById('audioModeToggle').checked);

                apiKey = document.getElementById('apiKeyInput').value;
                localStorage.setItem('apiKey', apiKey);

                localStorage.setItem('systemPrompt', systemPrompt);
                localStorage.setItem('language', currentLanguage);

                updateUILanguage(currentLanguage);

                settingsModal.style.display = 'none';
            } else {
                // Open Settings
                document.getElementById('systemPrompt').value = systemPrompt;
                languageSelect.value = currentLanguage;
                // Load new fields
                document.getElementById('emailInput').value = localStorage.getItem('userEmail') || '';
                document.getElementById('phoneInput').value = localStorage.getItem('userPhone') || '';
                document.getElementById('audioModeToggle').checked = localStorage.getItem('audioMode') === 'true';
                document.getElementById('apiKeyInput').value = apiKey;

                settingsModal.style.display = 'flex';
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('active');
        }

        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
        }

        // Drag and Drop Support
        const dropZone = document.body;

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            document.querySelector('.chat-container').style.border = '2px dashed var(--accent)';
        }

        function unhighlight(e) {
            document.querySelector('.chat-container').style.border = 'none';
        }

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files[0]) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        currentImageBase64 = e.target.result;
                        imagePreview.src = currentImageBase64;
                        imagePreviewContainer.style.display = 'block';
                        // Optional: Focus input
                        input.focus();
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    processPdf(file);
                }
            }
        }



        function newChat() {
            currentChatId = Date.now();
            chatContent.innerHTML = '';

            // Greeting based on language
            const t = translations[currentLanguage];
            addMessage('ai', t.greeting);

            // Mark the greeting message for dynamic translation
            const lastMsg = chatContent.lastElementChild;
            if (lastMsg) {
                const textDiv = lastMsg.querySelector('.message-text');
                if (textDiv) textDiv.setAttribute('data-translate', 'greeting');
            }

            messageCount = 0;
            isPinVerified = false;
            conversationHistory = []; // Reset history

            renderChatHistory();
        }

        function saveCurrentChat() {
            if (conversationHistory.length === 0) return;

            const existingIndex = allChats.findIndex(c => c.id === currentChatId);

            // Determine title from first user message
            let title = "New Chat";
            const firstUserMsg = conversationHistory.find(m => m.role === 'user');
            if (firstUserMsg) {
                if (typeof firstUserMsg.content === 'string') {
                    title = firstUserMsg.content.substring(0, 30);
                } else if (Array.isArray(firstUserMsg.content)) {
                    title = firstUserMsg.content[0].text.substring(0, 30);
                }
            }

            const chatData = {
                id: currentChatId,
                title: title,
                messages: conversationHistory,
                timestamp: Date.now()
            };

            if (existingIndex > -1) {
                allChats[existingIndex] = chatData;
            } else {
                allChats.push(chatData);
            }
            localStorage.setItem('allChats', JSON.stringify(allChats));
            renderChatHistory();
        }

        function speakText(btn) {
            const msgContent = btn.closest('.message-content');
            const textDiv = msgContent.querySelector('.message-text');
            const text = textDiv.getAttribute('data-raw-text') || textDiv.innerText;

            if ('speechSynthesis' in window) {
                // Cancel current speech
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                // Detect language
                if (currentLanguage === 'de') utterance.lang = 'de-DE';
                else if (currentLanguage === 'ar') utterance.lang = 'ar-SA';
                else if (currentLanguage === 'uk') utterance.lang = 'uk-UA';
                else utterance.lang = 'en-US';

                speechSynthesis.speak(utterance);
            } else {
                alert("Text-to-Speech not supported in this browser.");
            }
        }

        function exportChat() {
            if (conversationHistory.length === 0) {
                alert("No chat to export.");
                return;
            }

            let exportText = "Zen Chat Export\n\n";
            conversationHistory.forEach(msg => {
                let content = msg.content;
                if (Array.isArray(content)) {
                    content = content.map(c => c.type === 'text' ? c.text : '[Image]').join(' ');
                }
                exportText += `[${msg.role.toUpperCase()}]: ${content}\n\n`;
            });

            const blob = new Blob([exportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `zen-chat-export-${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function toggleSearch() {
            const container = document.getElementById('searchContainer');
            const input = document.getElementById('chatSearchInput');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                input.focus();
            } else {
                container.style.display = 'none';
                input.value = '';
                filterChats(''); // Reset filter
            }
        }

        function filterChats(query) {
            const list = document.getElementById('chatHistoryList');
            const items = list.getElementsByClassName('history-item');
            query = query.toLowerCase();

            Array.from(items).forEach(item => {
                const text = item.innerText.toLowerCase();
                if (text.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function openLibrary() {
            document.getElementById('libraryModal').style.display = 'flex';
            renderLibrary();
        }

        function addToLibrary(role, text, img) {
            try {
                const item = {
                    id: Date.now(),
                    role: role,
                    text: text || '',
                    image: img || null,
                    date: new Date().toISOString()
                };
                allLibrary.push(item);
                localStorage.setItem('allLibrary', JSON.stringify(allLibrary));
                alert('Saved to Library! 📚');
            } catch (e) {
                alert('Storage full! Could not save to library.');
            }
        }

        function deleteFromLibrary(id) {
            if (confirm('Möchtest du dieses Element wirklich löschen?')) {
                allLibrary = allLibrary.filter(i => i.id !== id);
                localStorage.setItem('allLibrary', JSON.stringify(allLibrary));
                renderLibrary();
            }
        }

        let currentLibFilter = 'all';

        function setLibFilter(filter, btn) {
            currentLibFilter = filter;
            document.querySelectorAll('.lib-filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderLibrary();
        }

        function useLibraryItem(text) {
            input.value = text;
            input.style.height = 'auto';
            document.getElementById('libraryModal').style.display = 'none';
            input.focus();
        }

        function renderLibrary() {
            const list = document.getElementById('libraryList');
            const search = document.getElementById('libSearch').value.toLowerCase();
            list.innerHTML = '';

            let filtered = allLibrary.filter(item => {
                // Filter by Type
                if (currentLibFilter === 'image' && !item.image) return false;
                if (currentLibFilter === 'text' && item.image) return false;

                // Filter by Search
                if (search && !item.text.toLowerCase().includes(search)) return false;

                return true;
            });

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div style="grid-column:1/-1; text-align:center; color:var(--text-secondary); margin-top:50px; display:flex; flex-direction:column; align-items:center; gap:10px;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" style="opacity:0.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        Keine Elemente gefunden.
                    </div>`;
                return;
            }

            filtered.slice().reverse().forEach(item => {
                const card = document.createElement('div');
                card.className = 'history-item';
                card.style.background = 'var(--bg-color)';
                card.style.border = '1px solid var(--border)';
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';

                let html = '';

                // Image Header
                if (item.image) {
                    html += `
                    <div style="position:relative; width:100%; height:160px; overflow:hidden; border-radius: 6px 6px 0 0; margin: -15px -15px 10px -15px;">
                        <img src="${item.image}" style="width:100%; height:100%; object-fit:cover; cursor:pointer; transition:transform 0.3s;" onclick="window.open('${item.image}')" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    </div>`;
                }

                // Content
                html += `<div style="font-size:13px; margin-bottom:15px; max-height:100px; overflow-y:auto; line-height:1.5; color:var(--text-primary);">${marked.parse(item.text)}</div>`;

                // Actions Footer
                html += `
                    <div class="lib-card-actions">
                        <button class="lib-btn" onclick="deleteFromLibrary(${item.id})" title="Löschen">🗑️</button>
                        ${!item.image ? `<button class="lib-btn primary" onclick="useLibraryItem(\`${item.text.replace(/`/g, '\\`').replace(/"/g, '&quot;')}\`)" title="Verwenden">Verwenden ↵</button>` : ''}
                        ${item.image ? `<button class="lib-btn primary" onclick="window.open('${item.image}')" title="Ansehen">Ansehen ↗</button>` : ''}
                    </div>
                    <div style="font-size:10px; color:var(--text-secondary); margin-top:8px; text-align:right;">${new Date(item.date).toLocaleDateString()}</div>
                `;

                card.innerHTML = html;
                list.appendChild(card);
            });
        }

        function renderChatHistory() {
            const list = document.getElementById('chatHistoryList');
            list.innerHTML = '';

            // Sort by newest first
            const sortedChats = [...allChats].sort((a, b) => b.timestamp - a.timestamp);

            sortedChats.forEach(chat => {
                const item = document.createElement('div');
                item.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
                item.onclick = () => loadChat(chat.id);
                item.innerHTML = `
                    <span>${chat.title || 'Chat'}</span>
                    <button class="delete-chat" onclick="deleteChat(event, ${chat.id})">&times;</button>
                `;
                list.appendChild(item);
            });
        }

        function loadChat(id) {
            const chat = allChats.find(c => c.id === id);
            if (!chat) return;

            currentChatId = chat.id;
            conversationHistory = chat.messages || [];
            chatContent.innerHTML = '';

            // Re-render messages
            conversationHistory.forEach(msg => {
                let text = "";
                let imgSrc = null;

                if (Array.isArray(msg.content)) {
                    // Handle multimodal (User sent image)
                    msg.content.forEach(c => {
                        if (c.type === 'text') text += c.text;
                        if (c.type === 'image_url') imgSrc = c.image_url.url;
                    });
                } else {
                    // Handle text or generated image marker
                    text = msg.content;
                    if (typeof text === 'string' && text.startsWith('IMAGE_GENERATED_V2:')) {
                        const parts = text.replace('IMAGE_GENERATED_V2:', '').split('|PROMPT:');
                        imgSrc = parts[0];
                        text = parts[1] || "Generated Image";
                    }
                }
                addMessage(msg.role, text, imgSrc, false); // false = don't save again
            });

            // Highlight active
            renderChatHistory();
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        function deleteChat(e, id) {
            e.stopPropagation();
            if (confirm('Delete this chat?')) {
                allChats = allChats.filter(c => c.id !== id);
                localStorage.setItem('allChats', JSON.stringify(allChats));
                if (currentChatId === id) newChat();
                else renderChatHistory();
            }
        }

        // Initialize history on load
        window.addEventListener('load', () => {
            renderChatHistory();
            renderPresentationHistory();
        });

        // --- Presentation History Functions ---
        function savePresentation(topic, slides) {
            const pptData = {
                id: Date.now(),
                title: topic,
                slides: slides,
                timestamp: Date.now()
            };
            allPresentations.push(pptData);
            localStorage.setItem('allPresentations', JSON.stringify(allPresentations));
            renderPresentationHistory();
        }

        function renderPresentationHistory() {
            const list = document.getElementById('presentationHistoryList');
            list.innerHTML = '';

            const sortedPpts = [...allPresentations].sort((a, b) => b.timestamp - a.timestamp);

            sortedPpts.forEach(ppt => {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.onclick = () => loadPresentation(ppt.id);
                item.innerHTML = `
                    <span style="display:flex; align-items:center; gap:5px;">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>
                        ${ppt.title}
                    </span>
                    <button class="delete-chat" onclick="deletePresentation(event, ${ppt.id})">&times;</button>
                `;
                list.appendChild(item);
            });
        }

        function loadPresentation(id) {
            const ppt = allPresentations.find(p => p.id === id);
            if (!ppt) return;
            renderSlides(ppt.slides, 'warm'); // Defaulting to warm for now
        }

        function deletePresentation(e, id) {
            e.stopPropagation();
            if (confirm('Delete this presentation?')) {
                allPresentations = allPresentations.filter(p => p.id !== id);
                localStorage.setItem('allPresentations', JSON.stringify(allPresentations));
                renderPresentationHistory();
            }
        }

        let selectedTemplate = 'warm';

        function selectTemplate(el, template) {
            document.querySelectorAll('.template-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            selectedTemplate = template;
        }

        function openPresentationModal() {
            document.getElementById('pptSetupModal').style.display = 'flex';
            // Reset topic
            document.getElementById('pptTopic').value = '';
        }

        async function generatePresentation() {
            const topic = document.getElementById('pptTopic').value;
            const style = selectedTemplate;

            if (!topic) {
                alert("Bitte geben Sie ein Thema ein. / Please enter a topic.");
                return;
            }

            if (!apiKey) {
                alert("Bitte geben Sie Ihren API-Schlüssel in den Einstellungen ein. / Please enter your API Key in Settings.");
                return;
            }

            document.getElementById('pptSetupModal').style.display = 'none';

            // Show loading in chat
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message';
            loadingDiv.innerHTML = `
                <div class="avatar ai">AI</div>
                <div class="message-content">
                    <div class="message-name">Zen AI Presentation</div>
                    <div class="message-text">
                        <div style="width: 100%; max-width: 300px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 12px;">
                                <span id="pptStatus">Generating content...</span>
                                <span id="pptTime">0%</span>
                            </div>
                            <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                <div id="pptProgress" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>`;
            chatContent.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            // Simulate "Thinking" and "Researching" - Longer Duration
            const progressBar = loadingDiv.querySelector('#pptProgress');
            const statusText = loadingDiv.querySelector('#pptStatus');
            const timeText = loadingDiv.querySelector('#pptTime');

            let progress = 0;
            const interval = setInterval(() => {
                progress += 2; // Slower progress (was 5)
                if (progress > 95) progress = 95;
                if (progressBar) progressBar.style.width = `${progress}%`;
                if (timeText) timeText.innerText = `${progress}%`;

                if (statusText) {
                    if (progress < 30) statusText.innerText = "Researching content...";
                    else if (progress < 60) statusText.innerText = "Structuring slides...";
                    else if (progress < 85) statusText.innerText = "Designing layout...";
                    else statusText.innerText = "Finalizing presentation...";
                }

            }, 150); // Slower interval (was 100)

            try {
                let langName = "English";
                if (currentLanguage === 'de') langName = "German";
                if (currentLanguage === 'ar') langName = "Arabic";
                if (currentLanguage === 'uk') langName = "Ukrainian";

                // Enhanced Prompt for better quality
                let promptContext = `about "${topic}"`;
                if (topic.length > 100) {
                    promptContext = `based on the following content: """${topic}"""`;
                }

                const prompt = `Create a highly detailed, professional, and comprehensive presentation ${promptContext} in ${langName} language. 
                
                CRITICAL INSTRUCTIONS:
                1. Create between 8 and 15 slides. Do not make it too short. Take your time to cover the topic in depth.
                2. For "image_prompt", describe a "photorealistic, 4k, professional, cinematic lighting" image.
                3. Return ONLY a valid JSON array of objects.
                
                For each slide, choose the best layout based on the content:
                - "standard": Title, content, bullets, image.
                - "split": Title, content on left, large image on right.
                - "grid_3": Title, and 3 distinct cards (e.g., for benefits, features, steps).
                - "circular_4": Title, and 4 cyclical steps/points.

                Return strictly valid JSON in this format: 
                [
                    {
                        "layout": "standard" | "split" | "grid_3" | "circular_4",
                        "title": "Slide Title",
                        "content": "Main paragraph text...",
                        "bullets": ["Point 1", "Point 2"],
                        "image_prompt": "English description for AI image",
                        "cards": [{"title": "Card Title", "content": "Short text", "icon": "❤️"}, ...], // Only for grid_3 (3 items)
                        "steps": [{"title": "Step Title", "content": "Short text"}, ...] // Only for circular_4 (4 items)
                    }
                ]
                Do not include markdown formatting or code blocks, just the raw JSON array.`;

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o",
                        messages: [{ role: "user", content: prompt }]
                    })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                // Complete progress
                clearInterval(interval);
                progressBar.style.width = '100%';
                timeText.innerText = '100%';
                statusText.innerText = 'Done!';

                setTimeout(() => {
                    chatContent.removeChild(loadingDiv);

                    let content = data.choices[0].message.content;
                    content = content.replace(/```json/g, '').replace(/```/g, '').trim();

                    const slides = JSON.parse(content);

                    // Save to history
                    savePresentation(topic, slides);

                    renderSlides(slides, style);

                    // Add to Chat as well
                    const pptCard = `
                        <div style="background: var(--input-bg); border: 1px solid var(--border); border-radius: 10px; padding: 15px; margin-top: 10px;">
                            <h3 style="margin-top:0;">📊 Presentation: ${topic}</h3>
                            <p style="font-size: 12px; color: var(--text-secondary);">${slides.length} Slides generated.</p>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button onclick="renderSlides(${JSON.stringify(slides).replace(/"/g, '&quot;')}, '${style}')" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Open Slides</button>
                                <button onclick="exportToPDF()" style="background:var(--input-bg); border:1px solid var(--border); color:var(--text-primary); padding:5px 10px; border-radius:5px; cursor:pointer;">Download PDF</button>
                            </div>
                        </div>
                    `;
                    addMessage('ai', `I have generated the presentation "${topic}". You can view it below or download it as PDF.\n\nTo edit, you can click on the text in the slides directly, or tell me what changes you'd like to make and I can regenerate it.`, null, true);

                    // Append the card manually to the last message
                    const lastMsg = chatContent.lastElementChild.querySelector('.message-text');
                    lastMsg.innerHTML += pptCard;

                    // Save this interaction to history
                    conversationHistory.push({
                        role: "assistant",
                        content: `[Generated Presentation: ${topic}]`
                    });
                    saveCurrentChat();

                }, 500);

            } catch (e) {
                clearInterval(interval);
                if (loadingDiv.parentNode) chatContent.removeChild(loadingDiv);
                alert("Error generating presentation: " + e.message);
            }
        }

        function renderSlides(slides, style) {
            const container = document.getElementById('slideContainer');
            container.innerHTML = '';

            // Set theme class
            container.className = 'slide-container'; // Reset
            if (style === 'warm') container.classList.add('theme-warm');
            else if (style === 'neon') container.classList.add('theme-neon');
            else if (style === 'corporate') container.classList.add('theme-corporate');
            else if (style === 'minimal') container.classList.add('theme-minimal');
            else container.classList.add('theme-modern'); // Default

            // Reset layout to horizontal by default
            toggleLayout('horizontal');

            slides.forEach((slide, index) => {
                const slideEl = document.createElement('div');
                slideEl.className = 'slide slide-animate'; // Add animation class
                slideEl.style.animationDelay = `${index * 0.2}s`; // Staggered animation

                // Make content editable
                slideEl.contentEditable = "true";
                slideEl.style.outline = "none"; // Remove outline on focus

                let bulletsHtml = '';
                if (slide.bullets && slide.bullets.length > 0) {
                    bulletsHtml = '<ul>' + slide.bullets.map(b => `<li>${b}</li>`).join('') + '</ul>';
                }

                // Image Generation (Pollinations)
                // Enhance prompt for professional look
                const enhancedImagePrompt = slide.image_prompt + ", photorealistic, 4k, cinematic lighting, professional photography, high detail";
                const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedImagePrompt)}?width=800&height=600&nologo=true`;

                let slideContentHtml = '';

                if (slide.layout === 'split') {
                    slideContentHtml = `
                        <div class="layout-split">
                            <div class="content-side">
                                <h2>${slide.title}</h2>
                                <p>${slide.content}</p>
                                ${bulletsHtml}
                            </div>
                            <div class="image-side">
                                <img src="${imageUrl}" alt="Slide Image">
                            </div>
                        </div>
                    `;
                } else if (slide.layout === 'grid_3' && slide.cards) {
                    const cardsHtml = slide.cards.map(c => `
                        <div class="grid-card">
                            <span class="grid-icon">${c.icon || '★'}</span>
                            <h3>${c.title}</h3>
                            <p style="font-size: 0.9rem;">${c.content}</p>
                        </div>
                    `).join('');

                    slideContentHtml = `
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center;">
                            <h2 style="text-align: center;">${slide.title}</h2>
                            <p style="text-align: center; max-width: 800px; margin: 0 auto 20px auto;">${slide.content}</p>
                            <div class="layout-grid">
                                ${cardsHtml}
                            </div>
                        </div>
                    `;
                } else if (slide.layout === 'circular_4' && slide.steps) {
                    const stepsHtml = slide.steps.map(s => `
                        <div class="circle-item">
                            <div style="font-weight:bold; margin-bottom:5px;">${s.title}</div>
                            <div style="font-size:0.8rem;">${s.content}</div>
                        </div>
                    `).join('');

                    slideContentHtml = `
                        <div style="height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <h2 style="text-align: center; margin-bottom: 30px;">${slide.title}</h2>
                            <div class="circle-container">
                                <div class="center-circle"></div>
                                ${stepsHtml}
                            </div>
                        </div>
                    `;
                } else {
                    // Standard Layout
                    slideContentHtml = `
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                            <img src="${imageUrl}" class="slide-image" alt="Slide Image" onerror="this.style.display='none'" style="height: 200px;">
                            <h2>${slide.title}</h2>
                            <p>${slide.content}</p>
                            ${bulletsHtml}
                        </div>
                    `;
                }

                slideEl.innerHTML = `
                    ${slideContentHtml}
                    <div class="slide-number">${index + 1} / ${slides.length}</div>
                `;
                container.appendChild(slideEl);
            });

            document.getElementById('pptViewModal').style.display = 'flex';
        }

        function toggleLayout(mode) {
            const container = document.getElementById('slideContainer');
            const btnH = document.getElementById('btnHorizontal');
            const btnV = document.getElementById('btnVertical');

            if (mode === 'vertical') {
                container.classList.add('vertical');
                btnH.classList.remove('active');
                btnV.classList.add('active');
            } else {
                container.classList.remove('vertical');
                btnH.classList.add('active');
                btnV.classList.remove('active');
            }
        }

        function exportToPDF() {
            const container = document.getElementById('slideContainer');
            const btn = document.getElementById('exportPdfBtn');
            const originalText = btn.innerHTML;
            btn.innerText = "Processing...";

            // Clone container to modify for PDF
            const clone = container.cloneNode(true);

            // Get computed background color of the original container to ensure theme matches
            const computedStyle = window.getComputedStyle(container);
            const bgColor = computedStyle.backgroundColor;
            const color = computedStyle.color;

            // Style clone for PDF (vertical layout, page breaks)
            clone.style.display = 'block';
            clone.style.width = '1123px'; // A4 Landscape width approx (in px at 96dpi)
            clone.style.height = 'auto';
            clone.style.overflow = 'visible';
            clone.style.background = bgColor;
            clone.style.color = color;
            clone.classList.add(container.className); // Ensure theme class is preserved

            const slides = clone.querySelectorAll('.slide');
            slides.forEach(slide => {
                slide.style.width = '100%';
                slide.style.height = '794px'; // A4 Landscape height approx
                slide.style.pageBreakAfter = 'always';
                slide.style.flex = 'none';
                slide.style.marginBottom = '0';
                slide.style.border = 'none'; // Remove borders for clean PDF
                slide.style.boxShadow = 'none';

                // Ensure images are visible
                const imgs = slide.querySelectorAll('img');
                imgs.forEach(img => {
                    img.style.maxWidth = '100%';
                    img.style.height = 'auto';
                    img.style.display = 'block';
                });
            });

            // Create temp wrapper
            const wrapper = document.createElement('div');
            wrapper.style.position = 'absolute';
            wrapper.style.top = '-9999px';
            wrapper.style.left = '0';
            wrapper.style.width = '1123px'; // Match clone width
            wrapper.appendChild(clone);
            document.body.appendChild(wrapper);

            const opt = {
                margin: 0,
                filename: `zenith-presentation-${Date.now()}.pdf`,
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    letterRendering: true,
                    backgroundColor: bgColor // Set background in canvas
                },
                jsPDF: { unit: 'px', format: [1123, 794], orientation: 'landscape' } // A4 Landscape
            };

            // Small delay to ensure DOM is ready
            setTimeout(() => {
                html2pdf().set(opt).from(clone).save().then(() => {
                    document.body.removeChild(wrapper);
                    btn.innerHTML = originalText;
                }).catch(err => {
                    console.error(err);
                    alert("PDF Export failed");
                    btn.innerHTML = originalText;
                    document.body.removeChild(wrapper);
                });
            }, 500);
        }

        function verifyPin() {
            if (pinInput.value === CORRECT_PIN) {
                isPinVerified = true;
                pinModal.style.display = 'none';
                pinError.style.display = 'none';
                pinInput.value = '';
                // For simplicity, let user click send again.
                alert(translations[currentLanguage].pinAccepted);
            } else {
                pinError.style.display = 'block';
            }
        }

        function addMessage(role, content, imageUrl = null, save = true) {
            const div = document.createElement('div');
            div.className = 'message';

            const avatar = document.createElement('div');
            avatar.className = `avatar ${role}`;
            avatar.innerText = role === 'user' ? 'U' : 'AI';

            const msgContent = document.createElement('div');
            msgContent.className = 'message-content';

            const name = document.createElement('div');
            name.className = 'message-name';
            name.style.display = 'flex';
            name.style.alignItems = 'center';
            name.style.justifyContent = 'space-between';

            // Actions Area
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.alignItems = 'center';
            actions.style.gap = '5px';

            if (role === 'assistant') {
                actions.innerHTML += `<button class="tts-btn" onclick="speakText(this)" title="Read aloud">🔊</button>`;
            }

            // Save to Library Button
            const libBtn = document.createElement('button');
            libBtn.className = 'tts-btn';
            libBtn.innerHTML = '🔖';
            libBtn.title = "Save to Library";
            libBtn.onclick = () => addToLibrary(role, content, imageUrl);
            actions.appendChild(libBtn);

            name.innerHTML = `<span>${role === 'user' ? 'Du' : 'Zenith AI'}</span>`;
            name.appendChild(actions);

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';

            // Render Image if present
            if (imageUrl) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.style.maxWidth = '100%';
                img.style.borderRadius = '10px';
                img.style.marginBottom = '10px';
                img.style.display = 'block';
                img.style.cursor = 'pointer';
                img.onclick = () => window.open(imageUrl);
                textDiv.appendChild(img);
            }

            textDiv.innerHTML += marked.parse(content);

            // Store raw text for TTS
            if (role === 'assistant') {
                textDiv.setAttribute('data-raw-text', content);
            }

            msgContent.appendChild(name);
            msgContent.appendChild(textDiv);

            div.appendChild(avatar);
            div.appendChild(msgContent);

            chatContent.appendChild(div);
            chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: 'smooth' });

            return div; // Return the element so we can remove it if needed (for loading messages)
        }

        async function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                if (file.type === 'application/pdf') {
                    await processPdf(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        currentImageBase64 = e.target.result;
                        imagePreview.src = currentImageBase64;
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        async function processPdf(file) {
            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const page = await pdf.getPage(1); // Get first page

                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                currentImageBase64 = canvas.toDataURL('image/jpeg');
                imagePreview.src = currentImageBase64;
                imagePreviewContainer.style.display = 'block';

            } catch (error) {
                console.error("Error processing PDF:", error);
                alert("Could not process PDF file.");
            }
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;

            if (files && files[0]) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        currentImageBase64 = e.target.result;
                        imagePreview.src = currentImageBase64;
                        imagePreviewContainer.style.display = 'block';
                        input.focus();
                    };
                    reader.readAsDataURL(file);
                } else if (file.type === 'application/pdf') {
                    processPdf(file);
                }
            }
        }

        function clearImage() {
            currentImageBase64 = null;
            imageInput.value = '';
            imagePreviewContainer.style.display = 'none';
            imagePreview.src = '';
        }

        async function sendMessage() {
            const text = input.value.trim();
            if (!text && !currentImageBase64) return;

            // PIN Check
            if (!isPinVerified && messageCount >= 1) {
                pinModal.style.display = 'flex';
                return;
            }

            if (!apiKey) {
                // Should not happen with default key, but just in case
                apiKey = defaultKey;
            }

            // Display User Message
            if (currentImageBase64) {
                addMessage('user', text, currentImageBase64);
            } else {
                addMessage('user', text);
            }

            input.value = '';
            input.style.height = 'auto';
            updateTokenCount('');

            // Keep image for API call then clear
            const imageToSend = currentImageBase64;
            clearImage();

            messageCount++;

            // Loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message';
            loadingDiv.innerHTML = `<div class="avatar ai">AI</div><div class="message-content"><div class="message-name">Zen Chat</div><div class="message-text">...</div></div>`;
            chatContent.appendChild(loadingDiv);
            chatArea.scrollTop = chatArea.scrollHeight;

            try {

                // Add Language Instruction
                let langInstruction = "Die Systemsprache ist Deutsch. Antworte standardmäßig auf Deutsch, es sei denn, der Benutzer fragt explizit nach einer anderen Sprache.";
                if (currentLanguage === 'en') langInstruction = "System language is English. Respond in English by default, unless the user explicitly asks for another language.";
                if (currentLanguage === 'ar') langInstruction = "لغة النظام هي العربية. أجب بالعربية افتراضياً، ما لم يطلب المستخدم لغة أخرى بوضوح.";
                if (currentLanguage === 'uk') langInstruction = "Системна мова - українська. Відповідайте українською за замовчуванням, якщо користувач явно не попросить іншу мову.";

                // Add Time Context & Image Gen Instruction
                const now = new Date();
                const timeContext = ` Current date and time: ${now.toLocaleString(currentLanguage)}.`;
                const imageGenInstruction = " If the user explicitly asks to generate, draw, or create an image, start your response STRICTLY with 'IMAGE_GEN: ' followed by the English prompt. If the user asks for a LOGO or ICON, start with 'LOGO_GEN: ' followed by the English prompt. Do not add any other text.";

                // Combine with system prompt
                const finalSystemContent = (systemPrompt ? systemPrompt + " " : "") + langInstruction + timeContext + imageGenInstruction;

                const systemMessage = { role: "system", content: finalSystemContent };

                // Construct User Message Content
                let userContent;
                if (imageToSend) {
                    userContent = [
                        { type: "text", text: text || "Analyze this image" },
                        { type: "image_url", image_url: { url: imageToSend } }
                    ];
                } else {
                    userContent = text;
                }

                // Add to history
                conversationHistory.push({ role: "user", content: userContent });

                // Prepare messages for API (System + History)
                const messages = [systemMessage, ...conversationHistory];

                const response = await fetch("https://api.openai.com/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4o", // Using gpt-4o for best vision support
                        messages: messages
                    })
                });

                const data = await response.json();
                chatContent.removeChild(loadingDiv);

                if (data.error) {
                    addMessage('ai', `⚠️ ${data.error.message}`);
                } else {
                    let aiResponse = data.choices[0].message.content;

                    // Check for Logo Generation
                    if (aiResponse.startsWith('LOGO_GEN:')) {
                        const imagePrompt = aiResponse.replace('LOGO_GEN:', '').trim();

                        // Show "Generating..." message
                        const genText = currentLanguage === 'de' ? 'Logo wird erstellt...' : (currentLanguage === 'ar' ? 'جاري تصميم الشعار...' : 'Generating logo...');
                        const loadingMsg = addMessage('ai', `🎨 ${genText}`, null, false); // false = don't save yet

                        // Enhance prompt for logos
                        const enhancedPrompt = `${imagePrompt}, vector logo, minimal, flat design, white background, high quality, professional, geometric, modern`;
                        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=512&height=512&nologo=true`;

                        // Remove loading message after a short delay to simulate processing, then show image
                        setTimeout(() => {
                            if (loadingMsg) loadingMsg.remove();
                            showGeneratedImage(imageUrl, imagePrompt, "Logo");
                        }, 1000);

                    } else if (aiResponse.startsWith('IMAGE_GEN:')) {
                        const imagePrompt = aiResponse.replace('IMAGE_GEN:', '').trim();

                        // Show "Generating..." message
                        const genText = currentLanguage === 'de' ? 'Bild wird generiert...' : (currentLanguage === 'ar' ? 'جاري إنشاء الصورة...' : 'Generating image...');
                        const loadingMsg = addMessage('ai', `🎨 ${genText}`, null, false);

                        // Enhance prompt for general images
                        const enhancedPrompt = `${imagePrompt}, masterpiece, best quality, ultra realistic, 8k, cinematic lighting, hdr, detailed texture, professional photography, award winning`;
                        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhancedPrompt)}?width=1024&height=1024&nologo=true`;

                        setTimeout(() => {
                            if (loadingMsg) loadingMsg.remove();
                            showGeneratedImage(imageUrl, imagePrompt, "Image");
                        }, 1000);

                    } else {
                        addMessage('ai', aiResponse);
                        conversationHistory.push({ role: "assistant", content: aiResponse });
                        saveCurrentChat();
                    }
                }

            } catch (e) {
                if (loadingDiv.parentNode) chatContent.removeChild(loadingDiv);
                addMessage('ai', `Error: ${e.message}`);
            }
        }

        function showGeneratedImage(url, prompt, type) {
            // Use standard addMessage for consistency
            addMessage('ai', `Generated: ${prompt}`, url);

            // Save specially formatted string to history for reload
            conversationHistory.push({ role: "assistant", content: `IMAGE_GENERATED_V2:${url}|PROMPT:${prompt}` });
            saveCurrentChat();
        }

        // Enter to send
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    </script>
</body>

</html>